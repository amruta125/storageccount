{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "apimInstanceName": {
      "type": "string",
      "metadata": {
        "description": "The name of your API Management service."
      }
    },
    "apimPublisherEmail": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "The email address of the owner of the service"
      }
    },
    "apimSku": {
      "type": "string",
      "allowedValues": [
        "Developer",
        "Premium"
      ],
      "defaultValue": "Developer",
      "metadata": {
        "description": "The pricing tier of this API Management service. Only Developer and Premium are supported when deploying into a shared VNET."
      }
    },
    "vnetName": {
      "defaultValue": "sf-apim-vnet",
      "type": "string",
      "metadata": {
        "description": "The name of the VNET that contains the Service Fabric cluster and API Management service deployment."
      }
    },
    "subnetName": {
      "defaultValue": "apim-subnet",
      "type": "string",
      "metadata": {
        "description": "The name subnet to deploy the API Management service to. This subnet cannot have any other resources in it and must be in the same VNET that contains the Service Fabric cluster back-end."
      }
    },
    "vnetVersion": {
      "defaultValue": "2017-03-01",
      "type": "string",
      "metadata": {
        "description": "The version of the VNET resource to which the subnet belongs as defined by the subnetName parameter."
      }
    },
    "networkSecurityGroupName": {
      "defaultValue": "apim-vnet-security",
      "type": "string",
      "metadata": {
        "description": "The name Network Security Group to deploy the API Management service to. This NSG must be applied to the subnet in the 'subnetName' parameter."
      }
    },
    "networkSecurityGroupVersion": {
      "defaultValue": "2017-03-01",
      "type": "string",
      "metadata": {
        "description": "The version of the Network Security Group resource."
      }
    }
  },
  "variables": {
    "location": "[string(resourceGroup().location)]",
    "apimIP": "[concat(parameters('apimInstanceName'), '-public-ip')]",
    "apimSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
  },
  "resources": [ 
     {
            "type": "Microsoft.ApiManagement/service/apis",
            "name": "[concat(parameters('apimInstanceName'), '/', parameters('apis_service_fabric_app_name'))]",
            "apiVersion": "2017-03-01",
            "scale": null,
            "properties": {
                "displayName": "Service Fabric App",
                "apiRevision": "1",
                "description": "",
                "serviceUrl": "http://servicefabric",
                "path": "myapp",
                "protocols": [
                    "http",
                    "https"
                ],
                "authenticationSettings": null,
                "subscriptionKeyParameterNames": null,
                "isCurrent": true
            },
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('apimInstanceName'))]"
            ]
        },
        {
            "type": "Microsoft.ApiManagement/service/apis/operations",
            "name": "[concat(parameters('apimInstanceName'), '/', parameters('apis_service_fabric_app_name'), '/', parameters('apis_service_fabric_app_name_operation'))]",
            "apiVersion": "2017-03-01",
            "scale": null,
            "properties": {
                "displayName": "Values",
                "method": "GET",
                "urlTemplate": "/api/values",
                "description": "",
                "policies": null
            },
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('apimInstanceName'))]",
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimInstanceName'), parameters('apis_service_fabric_app_name'))]"
            ]
        },
        {
            "type": "Microsoft.ApiManagement/service/apis/policies",
            "name": "[concat(parameters('apimInstanceName'), '/', parameters('apis_service_fabric_app_name'), '/', parameters('policies_policy_name'))]",
            "apiVersion": "2017-03-01",
            "properties": {
                "policyContent": "<policies>\r\n  <inbound>\r\n    <base />\r\n    <set-backend-service backend-id=\"servicefabric\" sf-service-instance-name=\"fabric:/ApiApplication/WebApiService\" sf-resolve-condition=\"@((int)context.Response.StatusCode != 200)\" />\r\n  </inbound>\r\n  <backend>\r\n    <base />\r\n  </backend>\r\n  <outbound>\r\n    <base />\r\n  </outbound>\r\n  <on-error>\r\n    <base />\r\n  </on-error>\r\n</policies>"
            },
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('apimInstanceName'))]",
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimInstanceName'), parameters('apis_service_fabric_app_name'))]",
                "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimInstanceName'), parameters('service_fabric_backend_name'))]"
            ]
        },
        {
            "type": "Microsoft.ApiManagement/service/products/apis",
            "name": "[concat(parameters('apimInstanceName'), '/', parameters('apim_service_fabric_product_name'), '/', parameters('apis_service_fabric_app_name'))]",
            "apiVersion": "2017-03-01",
            "scale": null,
            "properties": {},
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('apimInstanceName'))]",
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimInstanceName'), parameters('apis_service_fabric_app_name'))]",
                "[resourceId('Microsoft.ApiManagement/service/products', parameters('apimInstanceName'), parameters('apim_service_fabric_product_name'))]"
            ]
        }
  ]
}
